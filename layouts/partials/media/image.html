<!-- layouts/partials/media/image.html -->
{{/* 
Partial: media/image.html

Parameters (passed as a dictionary):
  src (string)          : The source path for the image.
  alt (string)          : Alternative text for the image.
  caption (string)      : Optional caption text.
  attribution (string)  : Optional copyright attribution text.
  size (string)         : Optional size indicator (large/medium/small/auto).
  lightbox (bool)       : If "true", wraps the image in a link for lightbox.
  link (string)         : Optional URL to link the image to (overrides lightbox).
  class (string)        : Optional additional CSS classes.
*/}}

{{ $src := .src }}
{{ $alt := .alt | default "Image" }}
{{ $caption := .caption }}
{{ $attribution := .attribution }}
{{ $size := .size | default "auto" }}
{{ $lightbox := .lightbox | default "true" }}
{{ $link := .link }}
{{ $class := .class }}
{{ $page := .page }}

{{ $hasLink := $link }}
{{ $lightboxEnabled := eq $lightbox "true" }}

{{ if and $hasLink $lightboxEnabled }}
  {{ warnf "Image '%s': Both link and lightbox=true provided. Link will be used. Set lightbox=\"false\" to suppress this warning." $src }}
{{ end }}

{{ if not $page }}
    {{ errorf "Error: page context is null! This shouldn't happen - check your partial/shortcode invocation." }}
{{ end }}

{{ $pagePath := $page.File.Path | default "unknown page" }}
{{ $img := false }}

{{/* Try page bundle first */}}
{{ if $page }}
    {{ with $page.Resources.Get $src }}
        {{ $img = . }}
    {{ end }}
{{ end }}

{{/* If not found in page bundle, try global assets */}}
{{ if not $img }}
    {{ with resources.Get $src }}
        {{ $img = . }}
    {{ end }}
{{ end }}

{{/* If not found locally, try remote */}}
{{ if not $img }}
    {{ with resources.GetRemote $src }}
        {{ $img = . }}
    {{ end }}
{{ end }}

{{/* If image still not found, provide detailed error */}}
{{ if not $img }}
    {{ errorf "Image '%s' was not found! Checked: page bundle for '%s', global assets, and remote sources. Page: %s" $src $src $pagePath }}
{{ end }}

{{ $fallbackUrl := $img.RelPermalink }}
{{ $filter := images.Process "webp" }}
{{ $imgWebp := $img.Filter $filter }}
{{ if not $imgWebp }}
  {{ errorf "WebP conversion failed for image: %s" $src }}
{{ end }}
{{ $defaultUrl := $imgWebp.RelPermalink }}

<figure class="image image-{{ $size }} {{ $class }}">
  {{ if $hasLink }}
    <a href="{{ $link }}" title="{{ $alt }}" class="image-link">
  {{ else if $lightboxEnabled }}
    <a href="{{ $fallbackUrl }}" class="lightbox-url lightbox-image" title="{{ path.Base $src }}">
  {{ end }}
    <picture>
      <source srcset="{{ $defaultUrl }}" type="image/webp">
      <img src="{{ $fallbackUrl }}" alt="{{ $alt }}" class="responsive">
    </picture>
  {{ if or $hasLink $lightboxEnabled }}
    </a>
  {{ end }}

  {{ if or $caption $attribution }}
    <figcaption>
      {{ with $caption }}{{ . | safeHTML }}{{ end }}
      {{ with $attribution }}<span class="copyright">{{ . | safeHTML }}</span>{{ end }}
    </figcaption>
  {{ end }}
</figure>